server:
  port: 8000

spring:
  application:
    name: rdf-forge-gateway
  
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${KEYCLOAK_ISSUER_URI:http://localhost:8080/realms/rdfforge}
          jwk-set-uri: ${KEYCLOAK_JWK_URI:http://localhost:8080/realms/rdfforge/protocol/openid-connect/certs}
  
  cloud:
    gateway:
      routes:
        - id: pipeline-service
          uri: ${PIPELINE_SERVICE_URL:http://localhost:8001}
          predicates:
            - Path=/api/v1/pipelines/**,/api/v1/operations/**,/api/v1/templates/**
          filters:
            - name: CircuitBreaker
              args:
                name: pipelineCircuitBreaker
                fallbackUri: forward:/api/v1/fallback
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY
        
        - id: shacl-service
          uri: ${SHACL_SERVICE_URL:http://localhost:8002}
          predicates:
            - Path=/api/v1/shapes/**,/api/v1/validation/**
          filters:
            - name: CircuitBreaker
              args:
                name: shaclCircuitBreaker
                fallbackUri: forward:/api/v1/fallback
        
        - id: job-service
          uri: ${JOB_SERVICE_URL:http://localhost:8003}
          predicates:
            - Path=/api/v1/jobs/**,/api/v1/schedules/**
          filters:
            - name: CircuitBreaker
              args:
                name: jobCircuitBreaker
                fallbackUri: forward:/api/v1/fallback
        
        - id: data-service
          uri: ${DATA_SERVICE_URL:http://localhost:8004}
          predicates:
            - Path=/api/v1/data/**
          filters:
            - name: CircuitBreaker
              args:
                name: dataCircuitBreaker
                fallbackUri: forward:/api/v1/fallback
        
        - id: dimension-service
          uri: ${DIMENSION_SERVICE_URL:http://localhost:8005}
          predicates:
            - Path=/api/v1/dimensions/**,/api/v1/hierarchies/**
          filters:
            - name: CircuitBreaker
              args:
                name: dimensionCircuitBreaker
                fallbackUri: forward:/api/v1/fallback
        
        - id: triplestore-service
          uri: ${TRIPLESTORE_SERVICE_URL:http://localhost:8006}
          predicates:
            - Path=/api/v1/triplestores/**,/api/v1/sparql/**,/api/v1/graphs/**
          filters:
            - name: CircuitBreaker
              args:
                name: triplestoreCircuitBreaker
                fallbackUri: forward:/api/v1/fallback
      
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Credentials Access-Control-Allow-Origin
      
      globalcors:
        corsConfigurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - PATCH
              - OPTIONS
            allowedHeaders: "*"
            exposedHeaders:
              - Content-Disposition
              - X-Total-Count
              - X-Request-Id
              - Link

resilience4j:
  circuitbreaker:
    configs:
      default:
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 10000
        permittedNumberOfCallsInHalfOpenState: 5
    instances:
      pipelineCircuitBreaker:
        baseConfig: default
      shaclCircuitBreaker:
        baseConfig: default
      jobCircuitBreaker:
        baseConfig: default
      dataCircuitBreaker:
        baseConfig: default
      dimensionCircuitBreaker:
        baseConfig: default
      triplestoreCircuitBreaker:
        baseConfig: default

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,gateway,prometheus
  endpoint:
    health:
      show-details: when_authorized
    gateway:
      enabled: true

logging:
  level:
    io.rdfforge: DEBUG
    org.springframework.cloud.gateway: INFO
    org.springframework.security: INFO
    reactor.netty: INFO
