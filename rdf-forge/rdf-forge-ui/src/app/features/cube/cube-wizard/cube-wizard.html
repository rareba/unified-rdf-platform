<div class="cube-wizard">
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <mat-icon class="header-icon">inventory_2</mat-icon>
      <div>
        <h1>Create Data Cube</h1>
        <p class="header-subtitle">Build an RDF Data Cube from your tabular data</p>
      </div>
    </div>
    <div class="header-actions">
      <button mat-button routerLink="/">
        <mat-icon>close</mat-icon>
        Cancel
      </button>
    </div>
  </div>

  <!-- Progress Steps -->
  <div class="step-indicators">
    @for (step of ['Basic Info', 'Data Source', 'Mapping', 'Metadata', 'Validate', 'Publish']; track step; let i = $index) {
      <div class="step-indicator"
           [class.completed]="getStepStatus(i) === 'completed'"
           [class.current]="getStepStatus(i) === 'current'"
           [class.clickable]="i <= maxStepReached()"
           (click)="goToStep(i)">
        <div class="step-number">
          @if (getStepStatus(i) === 'completed') {
            <mat-icon>check</mat-icon>
          } @else {
            {{ i + 1 }}
          }
        </div>
        <div class="step-label">{{ step }}</div>
      </div>
      @if (i < 5) {
        <div class="step-connector" [class.completed]="getStepStatus(i) === 'completed'"></div>
      }
    }
  </div>

  <!-- Main Content -->
  <div class="wizard-content">
    <!-- Step 0: Basic Info -->
    @if (activeStep() === 0) {
      <div class="step-panel">
        <div class="step-header">
          <mat-icon>info</mat-icon>
          <div>
            <h2>Cube Information</h2>
            <p>Define the basic properties of your data cube</p>
          </div>
        </div>

        <div class="form-content">
          <div class="form-section">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Cube Name <span class="required">*</span></mat-label>
              <input matInput [ngModel]="cubeName()" (ngModelChange)="cubeName.set($event)"
                     placeholder="e.g., Population Statistics 2024" />
              <mat-hint>A descriptive name for your data cube</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Description</mat-label>
              <textarea matInput [ngModel]="cubeDescription()" (ngModelChange)="cubeDescription.set($event)"
                        rows="3" placeholder="Describe the content and purpose of this cube..."></textarea>
            </mat-form-field>

            <div class="form-row">
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Base URI <span class="required">*</span></mat-label>
                <input matInput [ngModel]="baseUri()" (ngModelChange)="baseUri.set($event)"
                       placeholder="https://example.org/cube/" />
                <mat-hint>The namespace for all cube resources</mat-hint>
              </mat-form-field>

              <div class="form-field">
                <label>Cube Identifier</label>
                <div class="id-input-group">
                  <mat-checkbox [ngModel]="useAutoId()" (ngModelChange)="useAutoId.set($event)" id="autoId">
                    Auto-generate from name
                  </mat-checkbox>
                </div>
                @if (useAutoId()) {
                  <div class="generated-id">
                    <code>{{ generatedId() || '...' }}</code>
                  </div>
                } @else {
                  <mat-form-field appearance="outline" class="w-full">
                    <input matInput [ngModel]="cubeId()" (ngModelChange)="cubeId.set($event)"
                           placeholder="my-cube-id" />
                  </mat-form-field>
                }
              </div>
            </div>
          </div>

          @if (cubeName() && baseUri()) {
            <div class="preview-box">
              <label>Full Cube URI:</label>
              <code>{{ baseUri() }}{{ useAutoId() ? generatedId() : cubeId() }}</code>
            </div>
          }
        </div>
      </div>
    }

    <!-- Step 1: Data Source -->
    @if (activeStep() === 1) {
      <div class="step-panel">
        <div class="step-header">
          <mat-icon>storage</mat-icon>
          <div>
            <h2>Select Data Source</h2>
            <p>Choose an existing data source or upload a new file</p>
          </div>
        </div>

        <div class="form-content">
          <div class="source-type-selector">
            <mat-button-toggle-group [value]="sourceType()" (change)="sourceType.set($event.value)">
              <mat-button-toggle value="existing">
                <mat-icon>storage</mat-icon>
                Existing Data Source
              </mat-button-toggle>
              <mat-button-toggle value="upload">
                <mat-icon>upload</mat-icon>
                Upload New File
              </mat-button-toggle>
            </mat-button-toggle-group>
          </div>

          @if (sourceType() === 'existing') {
            <div class="data-source-list">
              @if (loadingDataSources()) {
                <div class="loading-state">
                  <mat-spinner diameter="40"></mat-spinner>
                  <span>Loading data sources...</span>
                </div>
              } @else if (dataSources().length === 0) {
                <div class="empty-state">
                  <mat-icon>inbox</mat-icon>
                  <h4>No Data Sources</h4>
                  <p>Upload a file to get started</p>
                  <button mat-raised-button color="primary" (click)="sourceType.set('upload')">
                    <mat-icon>upload</mat-icon>
                    Upload File
                  </button>
                </div>
              } @else {
                <div class="source-grid">
                  @for (source of dataSources(); track source.id) {
                    <div class="source-card"
                         [class.selected]="selectedDataSource()?.id === source.id"
                         (click)="onDataSourceSelect(source)">
                      <div class="source-icon">
                        <mat-icon>{{ source.format === 'csv' || source.format === 'xlsx' ? 'table_chart' : 'description' }}</mat-icon>
                      </div>
                      <div class="source-info">
                        <div class="source-name">{{ source.name }}</div>
                        <div class="source-meta">
                          <span class="source-format">{{ source.format }}</span>
                          @if (source.rowCount) {
                            <span class="source-rows">{{ source.rowCount | number }} rows</span>
                          }
                        </div>
                      </div>
                      @if (selectedDataSource()?.id === source.id) {
                        <mat-icon class="selected-icon" color="primary">check_circle</mat-icon>
                      }
                    </div>
                  }
                </div>
              }
            </div>
          } @else {
            <div class="upload-section">
              <mat-expansion-panel>
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    <mat-icon>settings</mat-icon>
                    CSV Options
                  </mat-panel-title>
                </mat-expansion-panel-header>
                <div class="options-grid">
                  <mat-form-field appearance="outline">
                    <mat-label>Delimiter</mat-label>
                    <mat-select [value]="delimiter()" (valueChange)="delimiter.set($event)">
                      @for (opt of delimiterOptions; track opt.value) {
                        <mat-option [value]="opt.value">{{ opt.label }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                  <mat-form-field appearance="outline">
                    <mat-label>Encoding</mat-label>
                    <mat-select [value]="encoding()" (valueChange)="encoding.set($event)">
                      @for (opt of encodingOptions; track opt.value) {
                        <mat-option [value]="opt.value">{{ opt.label }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                  <div class="form-field checkbox-field">
                    <mat-checkbox [checked]="hasHeader()" (change)="hasHeader.set($event.checked)">
                      First row contains headers
                    </mat-checkbox>
                  </div>
                </div>
              </mat-expansion-panel>

              <div class="upload-dropzone"
                   [class.uploading]="uploading()"
                   [class.drag-over]="isDragOver()"
                   (dragover)="onDragOver($event)"
                   (dragleave)="onDragLeave($event)"
                   (drop)="onDrop($event)">
                <input type="file" #fileInput hidden accept=".csv,.xls,.xlsx,.tsv"
                       (change)="onFileInputChange($event)">
                <div class="upload-content" (click)="fileInput.click()">
                  @if (uploading()) {
                    <mat-spinner diameter="40"></mat-spinner>
                    <p>Uploading...</p>
                  } @else {
                    <mat-icon>cloud_upload</mat-icon>
                    <p>Drag and drop files here or click to browse</p>
                    <small>Supported formats: CSV, XLS, XLSX, TSV (max 50MB)</small>
                  }
                </div>
              </div>
            </div>
          }

          <!-- Data Preview -->
          @if (selectedDataSource()) {
            <div class="data-preview-section">
              <div class="section-title">
                <mat-icon>visibility</mat-icon>
                <span>Data Preview</span>
                <mat-chip>{{ selectedDataSource()?.name || '' }}</mat-chip>
              </div>
              @if (loadingColumns()) {
                <div class="loading-state small">
                  <mat-spinner diameter="30"></mat-spinner>
                  <span>Analyzing data...</span>
                </div>
              } @else {
                <app-data-preview [dataSourceId]="selectedDataSource()?.id || null"></app-data-preview>
              }
            </div>
          }
        </div>
      </div>
    }

    <!-- Step 2: Column Mapping -->
    @if (activeStep() === 2) {
      <div class="step-panel">
        <div class="step-header">
          <mat-icon>account_tree</mat-icon>
          <div>
            <h2>Map Columns</h2>
            <p>Define how each column maps to RDF cube components</p>
          </div>
        </div>

        <div class="form-content">
          <!-- Mapping Stats -->
          <div class="mapping-stats">
            <div class="stat-badge dimension">
              <mat-icon>apps</mat-icon>
              <span>{{ mappingStats().dimensions }} Dimensions</span>
            </div>
            <div class="stat-badge measure">
              <mat-icon>bar_chart</mat-icon>
              <span>{{ mappingStats().measures }} Measures</span>
            </div>
            <div class="stat-badge attribute">
              <mat-icon>label</mat-icon>
              <span>{{ mappingStats().attributes }} Attributes</span>
            </div>
            @if (mappingStats().ignored > 0) {
              <div class="stat-badge ignored">
                <mat-icon>visibility_off</mat-icon>
                <span>{{ mappingStats().ignored }} Ignored</span>
              </div>
            }
            <div class="stat-actions">
              <button mat-button (click)="autoAssignDimensions()"
                      matTooltip="Match columns to existing dimensions by name">
                <mat-icon>auto_fix_high</mat-icon>
                Auto-Assign Dimensions
              </button>
            </div>
          </div>

          <!-- Mapping Table -->
          <div class="mapping-table-container">
            <table mat-table [dataSource]="columnMappings()" class="mapping-table">
              <!-- Column Definition -->
              <ng-container matColumnDef="column">
                <th mat-header-cell *matHeaderCellDef style="width: 180px">Column</th>
                <td mat-cell *matCellDef="let mapping">
                  <div class="column-info">
                    <span class="column-name">{{ mapping.name }}</span>
                    <span class="column-type">{{ mapping.sourceType }}</span>
                  </div>
                </td>
              </ng-container>

              <!-- Role Definition -->
              <ng-container matColumnDef="role">
                <th mat-header-cell *matHeaderCellDef style="width: 140px">Role</th>
                <td mat-cell *matCellDef="let mapping; let i = index">
                  <mat-form-field appearance="outline" class="w-full">
                    <mat-select [value]="mapping.role" (valueChange)="updateMapping(i, 'role', $event)">
                      @for (opt of roleOptions; track opt.value) {
                        <mat-option [value]="opt.value">
                          <mat-chip [class]="'role-' + opt.value">{{ opt.label }}</mat-chip>
                        </mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </td>
              </ng-container>

              <!-- Datatype Definition -->
              <ng-container matColumnDef="datatype">
                <th mat-header-cell *matHeaderCellDef style="width: 140px">Datatype</th>
                <td mat-cell *matCellDef="let mapping; let i = index">
                  <mat-form-field appearance="outline" class="w-full">
                    <mat-select [value]="mapping.datatype" (valueChange)="updateMapping(i, 'datatype', $event)"
                               [disabled]="mapping.role === 'ignore'">
                      @for (opt of datatypeOptions; track opt.value) {
                        <mat-option [value]="opt.value">{{ opt.label }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </td>
              </ng-container>

              <!-- Dimension Reference Definition -->
              <ng-container matColumnDef="dimension">
                <th mat-header-cell *matHeaderCellDef>Dimension Reference</th>
                <td mat-cell *matCellDef="let mapping; let i = index">
                  @if (mapping.role === 'dimension') {
                    <div class="dimension-select-group">
                      <mat-form-field appearance="outline" class="flex-1">
                        <mat-select [value]="mapping.dimensionId" (valueChange)="updateMapping(i, 'dimensionId', $event)"
                                   placeholder="Link to dimension...">
                          <mat-option [value]="null">None</mat-option>
                          @for (dim of availableDimensions(); track dim.id) {
                            <mat-option [value]="dim.id">{{ dim.name }}</mat-option>
                          }
                        </mat-select>
                      </mat-form-field>
                      <button mat-icon-button (click)="openNewDimensionDialog(mapping.name)"
                              matTooltip="Create new dimension">
                        <mat-icon>add</mat-icon>
                      </button>
                    </div>
                  } @else {
                    <span class="text-muted">-</span>
                  }
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="['column', 'role', 'datatype', 'dimension']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['column', 'role', 'datatype', 'dimension'];"
                  [class.ignored-row]="row.role === 'ignore'"></tr>

              <!-- Empty state -->
              <tr class="mat-row" *matNoDataRow>
                <td class="mat-cell" colspan="4">
                  <div class="empty-hint">
                    <mat-icon>info</mat-icon>
                    <p>Select a data source to see column mappings</p>
                  </div>
                </td>
              </tr>
            </table>
          </div>

          @if (mappingStats().dimensions === 0 || mappingStats().measures === 0) {
            <div class="validation-hint warning">
              <mat-icon>warning</mat-icon>
              <span>A valid cube requires at least one dimension and one measure</span>
            </div>
          }
        </div>
      </div>
    }

    <!-- Step 3: Metadata -->
    @if (activeStep() === 3) {
      <div class="step-panel">
        <div class="step-header">
          <mat-icon>local_offer</mat-icon>
          <div>
            <h2>Cube Metadata</h2>
            <p>Add Dublin Core metadata to describe your data cube</p>
          </div>
        </div>

        <div class="form-content">
          <div class="form-section">
            <h3>Basic Information</h3>
            <div class="form-row">
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Title <span class="required">*</span></mat-label>
                <input matInput [ngModel]="metadata().title"
                       (ngModelChange)="updateMetadataTitle($event)" />
              </mat-form-field>
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Language</mat-label>
                <mat-select [value]="metadata().language"
                           (valueChange)="updateMetadataLanguage($event)">
                  @for (opt of languageOptions; track opt.value) {
                    <mat-option [value]="opt.value">{{ opt.label }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Description</mat-label>
              <textarea matInput [ngModel]="metadata().description"
                       (ngModelChange)="updateMetadataDescription($event)"
                       rows="3"></textarea>
            </mat-form-field>
          </div>

          <mat-divider></mat-divider>

          <div class="form-section">
            <h3>Publisher & License</h3>
            <div class="form-row">
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Publisher</mat-label>
                <input matInput [ngModel]="metadata().publisher"
                       (ngModelChange)="updateMetadataPublisher($event)"
                       placeholder="Organization name" />
              </mat-form-field>
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>License <span class="required">*</span></mat-label>
                <mat-select [value]="metadata().license"
                           (valueChange)="updateMetadataLicense($event)"
                           placeholder="Select license...">
                  @for (opt of licenseOptions; track opt.value) {
                    <mat-option [value]="opt.value">{{ opt.label }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>
          </div>

          <mat-divider></mat-divider>

          <div class="form-section">
            <h3>Additional Properties</h3>
            <div class="form-row">
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Issued Date</mat-label>
                <input matInput type="date" [ngModel]="metadata().issued"
                       (ngModelChange)="updateMetadataIssued($event)" />
              </mat-form-field>
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Accrual Periodicity</mat-label>
                <mat-select [value]="metadata().accrualPeriodicity"
                           (valueChange)="updateMetadataAccrualPeriodicity($event)"
                           placeholder="How often updated?">
                  @for (opt of periodicityOptions; track opt.value) {
                    <mat-option [value]="opt.value">{{ opt.label }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Keywords</mat-label>
              <input matInput [ngModel]="keywordsInput()"
                     (ngModelChange)="keywordsInput.set($event)"
                     placeholder="statistics, population, census (comma separated)" />
              <mat-hint>Separate multiple keywords with commas</mat-hint>
            </mat-form-field>

            <div class="form-row">
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Spatial Coverage</mat-label>
                <input matInput [ngModel]="metadata().spatial"
                       (ngModelChange)="updateMetadataSpatial($event)"
                       placeholder="e.g., Switzerland, Europe" />
              </mat-form-field>
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Temporal Coverage</mat-label>
                <input matInput [ngModel]="metadata().temporal"
                       (ngModelChange)="updateMetadataTemporal($event)"
                       placeholder="e.g., 2020-2024" />
              </mat-form-field>
            </div>
          </div>
        </div>
      </div>
    }

    <!-- Step 4: Validate -->
    @if (activeStep() === 4) {
      <div class="step-panel">
        <div class="step-header">
          <mat-icon>check_circle</mat-icon>
          <div>
            <h2>Validation & Preview</h2>
            <p>Verify your cube configuration before publishing</p>
          </div>
        </div>

        <div class="form-content">
          <!-- Validation Section -->
          <div class="validation-section">
            <div class="validation-header">
              <h3>Validation Checks</h3>
              <button mat-raised-button color="primary" (click)="runValidation()"
                     [disabled]="validating()">
                @if (validating()) {
                  <mat-spinner diameter="20"></mat-spinner>
                } @else {
                  <mat-icon>play_arrow</mat-icon>
                }
                Run Validation
              </button>
            </div>

            <div class="validation-list">
              @for (check of validationChecks(); track check.id) {
                <div class="validation-item" [class]="'status-' + check.status">
                  <div class="validation-icon">
                    @if (check.status === 'passed') {
                      <mat-icon color="primary">check_circle</mat-icon>
                    } @else if (check.status === 'failed') {
                      <mat-icon color="warn">cancel</mat-icon>
                    } @else if (check.status === 'warning') {
                      <mat-icon color="accent">warning</mat-icon>
                    } @else if (check.status === 'running') {
                      <mat-spinner diameter="24"></mat-spinner>
                    } @else {
                      <mat-icon>radio_button_unchecked</mat-icon>
                    }
                  </div>
                  <div class="validation-info">
                    <div class="validation-name">{{ check.name }}</div>
                    <div class="validation-desc">{{ check.description }}</div>
                    @if (check.message) {
                      <div class="validation-message">{{ check.message }}</div>
                    }
                  </div>
                  <mat-chip [class]="'status-' + check.status">{{ check.status | titlecase }}</mat-chip>
                </div>
              }
            </div>

            @if (validationComplete()) {
              <div class="validation-summary" [class.success]="validationSummary().failed === 0">
                @if (validationSummary().failed === 0) {
                  <mat-icon>check_circle</mat-icon>
                  <span>All validations passed! Ready to publish.</span>
                } @else {
                  <mat-icon>cancel</mat-icon>
                  <span>{{ validationSummary().failed }} validation(s) failed. Please fix issues before proceeding.</span>
                }
              </div>
            }
          </div>

          <mat-divider></mat-divider>

          <!-- Preview Section -->
          <div class="preview-section">
            <div class="preview-header">
              <h3>Generated Output Preview</h3>
              <mat-button-toggle-group [value]="previewTab()" (change)="previewTab.set($event.value)">
                <mat-button-toggle value="dsd">DSD</mat-button-toggle>
                <mat-button-toggle value="turtle">Turtle</mat-button-toggle>
                <mat-button-toggle value="pipeline">Pipeline</mat-button-toggle>
              </mat-button-toggle-group>
            </div>

            <div class="preview-content">
              <div class="preview-toolbar">
                <button mat-icon-button matTooltip="Copy to clipboard"
                       (click)="copyToClipboard(previewTab() === 'dsd' ? generateDsdPreview() : previewTab() === 'turtle' ? generateTurtlePreview() : generatePipelinePreview())">
                  <mat-icon>content_copy</mat-icon>
                </button>
              </div>
              <pre class="preview-code">@switch (previewTab()) {
                @case ('dsd') { {{ generateDsdPreview() }} }
                @case ('turtle') { {{ generateTurtlePreview() }} }
                @case ('pipeline') { {{ generatePipelinePreview() }} }
              }</pre>
            </div>
          </div>
        </div>
      </div>
    }

    <!-- Step 5: Publish -->
    @if (activeStep() === 5) {
      <div class="step-panel">
        <div class="step-header">
          <mat-icon>cloud_upload</mat-icon>
          <div>
            <h2>Publish Cube</h2>
            <p>Configure publishing options and create your data cube</p>
          </div>
        </div>

        <div class="form-content">
          <!-- Summary Card -->
          <div class="summary-card">
            <h3>Cube Summary</h3>
            <div class="summary-grid">
              <div class="summary-item">
                <label>Name</label>
                <span>{{ cubeName() }}</span>
              </div>
              <div class="summary-item">
                <label>Data Source</label>
                <span>{{ selectedDataSource()?.name }}</span>
              </div>
              <div class="summary-item">
                <label>Dimensions</label>
                <span>{{ mappingStats().dimensions }}</span>
              </div>
              <div class="summary-item">
                <label>Measures</label>
                <span>{{ mappingStats().measures }}</span>
              </div>
              <div class="summary-item">
                <label>License</label>
                <span>{{ getLicenseLabel() }}</span>
              </div>
              <div class="summary-item">
                <label>Publisher</label>
                <span>{{ metadata().publisher || '-' }}</span>
              </div>
            </div>
          </div>

          <mat-divider></mat-divider>

          <!-- Publish Options -->
          <div class="form-section">
            <h3>Publishing Options</h3>

            <div class="form-row">
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Destination Triplestore</mat-label>
                <mat-select [value]="publishOptions().triplestore"
                           (valueChange)="updatePublishTriplestore($event)"
                           placeholder="Select triplestore...">
                  @for (opt of triplestoreOptions(); track opt.value) {
                    <mat-option [value]="opt.value">{{ opt.label }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Target Graph URI</mat-label>
                <input matInput [ngModel]="publishOptions().graphUri"
                       (ngModelChange)="updatePublishGraphUri($event)" />
              </mat-form-field>
            </div>

            <div class="form-field checkbox-field">
              <mat-checkbox [checked]="publishOptions().createNamedGraph"
                           (change)="updatePublishCreateNamedGraph($event.checked)">
                Create named graph if it doesn't exist
              </mat-checkbox>
            </div>
          </div>

          <mat-divider></mat-divider>

          <div class="form-section">
            <h3>Pipeline Options</h3>

            <div class="form-field checkbox-field">
              <mat-checkbox [checked]="publishOptions().savePipeline"
                           (change)="updatePublishSavePipeline($event.checked)">
                Save pipeline for future updates
              </mat-checkbox>
            </div>

            @if (publishOptions().savePipeline) {
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Pipeline Name</mat-label>
                <input matInput [ngModel]="publishOptions().pipelineName"
                       (ngModelChange)="updatePublishPipelineName($event)" />
              </mat-form-field>
            }

            <div class="form-field checkbox-field">
              <mat-checkbox [checked]="publishOptions().runImmediately"
                           (change)="updatePublishRunImmediately($event.checked)">
                Run pipeline immediately after creation
              </mat-checkbox>
            </div>
          </div>

          @if (publishing()) {
            <div class="publish-progress">
              <mat-progress-bar mode="determinate" [value]="publishProgress()"></mat-progress-bar>
              <p>Publishing cube... {{ publishProgress() }}%</p>
            </div>
          }
        </div>
      </div>
    }
  </div>

  <!-- Navigation Footer -->
  <div class="wizard-footer">
    <div class="footer-left">
      @if (activeStep() > 0) {
        <button mat-stroked-button (click)="prevStep()" [disabled]="publishing()">
          <mat-icon>arrow_back</mat-icon>
          Back
        </button>
      }
    </div>
    <div class="footer-right">
      @if (activeStep() < 5) {
        <button mat-raised-button color="primary" (click)="nextStep()"
               [disabled]="!canProceed(activeStep())">
          Next
          <mat-icon>arrow_forward</mat-icon>
        </button>
      } @else {
        <button mat-raised-button color="primary" (click)="publishCube()"
               [disabled]="publishing() || !publishOptions().triplestore">
          @if (publishing()) {
            <mat-spinner diameter="20"></mat-spinner>
          } @else {
            <mat-icon>cloud_upload</mat-icon>
          }
          Publish Cube
        </button>
      }
    </div>
  </div>
</div>

<!-- New Dimension Dialog -->
@if (showNewDimensionDialog()) {
  <div class="dialog-backdrop" (click)="showNewDimensionDialog.set(false)"></div>
  <div class="dialog-container">
    <div class="dialog-header">
      <h2>Create New Dimension</h2>
      @if (!savingDimension()) {
        <button mat-icon-button (click)="showNewDimensionDialog.set(false)">
          <mat-icon>close</mat-icon>
        </button>
      }
    </div>
    <div class="dialog-content">
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Name <span class="required">*</span></mat-label>
        <input matInput [ngModel]="newDimension().name"
               (ngModelChange)="updateNewDimensionName($event)" />
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Type</mat-label>
        <mat-select [value]="newDimension().type"
                   (valueChange)="updateNewDimensionType($event)">
          @for (item of dimensionTypes; track item.value) {
            <mat-option [value]="item.value">
              <div class="dim-type-option">
                <span class="dim-type-label">{{ item.label }}</span>
                <small class="dim-type-desc">{{ item.description }}</small>
              </div>
            </mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-full">
        <mat-label>URI (optional)</mat-label>
        <input matInput [ngModel]="newDimension().uri"
               (ngModelChange)="updateNewDimensionUri($event)"
               placeholder="Auto-generated if empty" />
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Description</mat-label>
        <textarea matInput [ngModel]="newDimension().description"
                 (ngModelChange)="updateNewDimensionDescription($event)"
                 rows="2"></textarea>
      </mat-form-field>
    </div>
    <div class="dialog-footer">
      <button mat-button (click)="showNewDimensionDialog.set(false)" [disabled]="savingDimension()">
        <mat-icon>close</mat-icon>
        Cancel
      </button>
      <button mat-raised-button color="primary" (click)="saveNewDimension()" [disabled]="savingDimension()">
        @if (savingDimension()) {
          <mat-spinner diameter="20"></mat-spinner>
        } @else {
          <mat-icon>check</mat-icon>
        }
        Create
      </button>
    </div>
  </div>
}
