<p-toast></p-toast>

<div class="cube-wizard">
  <h1>Create Data Cube</h1>
  
  <p-stepper [value]="activeStep()">
    <p-step-list>
      <p-step [value]="0">Basic Info</p-step>
      <p-step [value]="1">Data Source</p-step>
      <p-step [value]="2">Dimensions</p-step>
      <p-step [value]="3">Review</p-step>
    </p-step-list>
    <p-step-panels>
      <p-step-panel [value]="0">
        <div class="flex flex-column gap-3 p-3">
          <div class="field">
            <label for="name" class="font-bold block mb-2">Cube Name</label>
            <input id="name" type="text" pInputText [ngModel]="cubeName()" (ngModelChange)="cubeName.set($event)" class="w-full" placeholder="My Data Cube" />
          </div>
          <div class="field">
            <label for="description" class="font-bold block mb-2">Description</label>
            <textarea id="description" pInputTextarea [ngModel]="cubeDescription()" (ngModelChange)="cubeDescription.set($event)" class="w-full" rows="3"></textarea>
          </div>
          <div class="field">
            <label for="baseUri" class="font-bold block mb-2">Base URI</label>
            <input id="baseUri" type="text" pInputText [ngModel]="baseUri()" (ngModelChange)="baseUri.set($event)" class="w-full" />
          </div>
          <div class="flex pt-4 justify-content-end">
            <p-button label="Next" icon="pi pi-arrow-right" iconPos="right" (onClick)="nextStep()"></p-button>
          </div>
        </div>
      </p-step-panel>

      <p-step-panel [value]="1">
        <div class="flex flex-column gap-3 p-3">
          <span class="font-bold">Select Data Source</span>
          <p-listbox [options]="dataSources()" [ngModel]="selectedDataSource()" (ngModelChange)="onDataSourceSelect($event)" optionLabel="name" [filter]="true" [style]="{'width':'100%'}">
            <ng-template let-source pTemplate="item">
              <div class="flex align-items-center gap-2">
                <i class="pi pi-file"></i>
                <div>
                  <div class="font-bold">{{ source.name }}</div>
                  <div class="text-sm text-500">{{ source.format }}</div>
                </div>
              </div>
            </ng-template>
          </p-listbox>
          
          @if (selectedDataSource()) {
            <div class="mt-3">
              <h4>Available Columns</h4>
              <div class="flex gap-2 flex-wrap">
                @for (col of sourceColumns(); track col.name) {
                  <span class="p-tag p-tag-info">{{ col.name }} ({{ col.type }})</span>
                }
              </div>
            </div>
          }

          <div class="flex pt-4 justify-content-between">
            <p-button label="Back" icon="pi pi-arrow-left" (onClick)="prevStep()" severity="secondary"></p-button>
            <p-button label="Next" icon="pi pi-arrow-right" iconPos="right" (onClick)="nextStep()" [disabled]="!selectedDataSource()"></p-button>
          </div>
        </div>
      </p-step-panel>

      <p-step-panel [value]="2">
        <div class="flex flex-column gap-3 p-3">
          <span class="font-bold">Select Dimensions</span>
          <p-listbox [options]="availableDimensions()" [ngModel]="selectedDimensions()" (ngModelChange)="selectedDimensions.set($event)" [multiple]="true" optionLabel="name" [metaKeySelection]="false" [checkbox]="true" [filter]="true" [style]="{'width':'100%'}"></p-listbox>
          
          @if (selectedDimensions().length > 0) {
            <div class="mt-3">
              <h4>Map Dimensions to Columns</h4>
              @for (dim of selectedDimensions(); track dim.uri) {
                @if (dim.id) {
                  <div class="field grid align-items-center">
                    <span class="col-12 md:col-4">{{ dim.name }}</span>
                    <div class="col-12 md:col-8">
                      <p-select [options]="sourceColumns()" [ngModel]="dimensionMappings()[dim.id]" (ngModelChange)="updateDimensionMapping(dim.id, $event)" optionLabel="name" optionValue="name" placeholder="Select Column" styleClass="w-full"></p-select>
                    </div>
                  </div>
                }
              }
            </div>
          }

          <div class="flex pt-4 justify-content-between">
            <p-button label="Back" icon="pi pi-arrow-left" (onClick)="prevStep()" severity="secondary"></p-button>
            <p-button label="Next" icon="pi pi-arrow-right" iconPos="right" (onClick)="nextStep()"></p-button>
          </div>
        </div>
      </p-step-panel>

      <p-step-panel [value]="3">
        <div class="flex flex-column gap-3 p-3">
          <div class="summary">
            <h3>Summary</h3>
            <p><strong>Name:</strong> {{ cubeName() }}</p>
            <p><strong>Source:</strong> {{ selectedDataSource()?.name }}</p>
            <p><strong>Dimensions:</strong> {{ selectedDimensions().length }} selected</p>
          </div>
          
          <div class="flex pt-4 justify-content-between">
            <p-button label="Back" icon="pi pi-arrow-left" (onClick)="prevStep()" severity="secondary"></p-button>
            <p-button label="Create Cube" icon="pi pi-check" (onClick)="createCube()" [loading]="creating()"></p-button>
          </div>
        </div>
      </p-step-panel>
    </p-step-panels>
  </p-stepper>
</div>
