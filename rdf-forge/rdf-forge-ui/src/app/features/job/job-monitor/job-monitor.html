<div class="job-monitor">
  @if (loading()) {
    <div class="loading">Loading job details...</div>
  } @else if (job()) {
    <div class="header">
      <div>
        <h1>Job {{ job()!.id.substring(0, 8) }}</h1>
        <p class="pipeline-name">{{ job()!.pipelineName }} v{{ job()!.pipelineVersion }}</p>
      </div>
      <div class="actions">
        <button mat-button (click)="goBack()">
          <mat-icon>arrow_back</mat-icon>
          Back
        </button>
        @if (job()!.status === 'running') {
          <button mat-raised-button color="warn" (click)="cancelJob()">
            <mat-icon>stop</mat-icon>
            Cancel
          </button>
        }
        @if (job()!.status === 'failed') {
          <button mat-raised-button color="accent" (click)="retryJob()">
            <mat-icon>refresh</mat-icon>
            Retry
          </button>
        }
      </div>
    </div>

    <div class="grid mt-4">
      <div class="col-12 lg:col-4">
        <mat-card>
          <mat-card-header>
            <mat-card-title>Status</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="status-info">
              <mat-chip-set>
                <mat-chip [class]="getStatusClass(job()!.status)">
                  {{ job()!.status }}
                </mat-chip>
              </mat-chip-set>
              @if (job()!.status === 'running') {
                <mat-progress-bar mode="determinate" [value]="job()!.progress" class="mt-3"></mat-progress-bar>
                <div class="progress-text">{{ job()!.progress }}%</div>
              }
            </div>
            <div class="info-row mt-3">
              <span class="label">Started</span>
              <span class="value">{{ formatDate(job()!.startedAt) }}</span>
            </div>
            <div class="info-row">
              <span class="label">Completed</span>
              <span class="value">{{ formatDate(job()!.completedAt) }}</span>
            </div>
            <div class="info-row">
              <span class="label">Duration</span>
              <span class="value">{{ formatDuration(job()!.duration) }}</span>
            </div>
            <div class="info-row">
              <span class="label">Triggered By</span>
              <span class="value">{{ job()!.triggeredBy }}</span>
            </div>
          </mat-card-content>
        </mat-card>

        @if (job()!.metrics) {
          <mat-card class="mt-3">
            <mat-card-header>
              <mat-card-title>Metrics</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="info-row">
                <span class="label">Rows Processed</span>
                <span class="value">{{ job()!.metrics!.rowsProcessed | number }}</span>
              </div>
              <div class="info-row">
                <span class="label">Quads Generated</span>
                <span class="value">{{ job()!.metrics!.quadsGenerated | number }}</span>
              </div>
            </mat-card-content>
          </mat-card>
        }

        @if (job()!.errorMessage) {
          <mat-card class="mt-3">
            <mat-card-header>
              <mat-card-title>Error</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="error-message">{{ job()!.errorMessage }}</div>
            </mat-card-content>
          </mat-card>
        }
      </div>

      <div class="col-12 lg:col-8">
        <mat-card>
          <mat-card-header>
            <mat-card-title>Logs</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="logs-container">
              @if (logs().length > 0) {
                <table mat-table [dataSource]="logs()" class="logs-table">
                  <ng-container matColumnDef="timestamp">
                    <th mat-header-cell *matHeaderCellDef>Time</th>
                    <td mat-cell *matCellDef="let log" class="log-time">{{ formatDate(log.timestamp) }}</td>
                  </ng-container>

                  <ng-container matColumnDef="level">
                    <th mat-header-cell *matHeaderCellDef>Level</th>
                    <td mat-cell *matCellDef="let log">
                      <mat-chip-set>
                        <mat-chip [class]="getLogClass(log.level)" class="log-chip">
                          {{ log.level }}
                        </mat-chip>
                      </mat-chip-set>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="message">
                    <th mat-header-cell *matHeaderCellDef>Message</th>
                    <td mat-cell *matCellDef="let log" class="log-message">{{ log.message }}</td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="['timestamp', 'level', 'message']"></tr>
                  <tr mat-row *matRowDef="let row; columns: ['timestamp', 'level', 'message']"></tr>
                </table>
              } @else {
                <div class="text-center text-muted">No logs available</div>
              }
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>
  } @else {
    <div class="not-found">Job not found</div>
  }
</div>
