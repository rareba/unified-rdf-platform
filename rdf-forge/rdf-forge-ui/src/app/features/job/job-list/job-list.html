<p-toast></p-toast>

<div class="job-list">
  <div class="header">
    <h1>Jobs</h1>
    <div class="actions">
      <span class="p-input-icon-left">
        <i class="pi pi-search"></i>
        <input type="text" pInputText placeholder="Search jobs..." [ngModel]="searchQuery()" (ngModelChange)="searchQuery.set($event)" />
      </span>
      <p-select [options]="statusOptions" [ngModel]="statusFilter()" (ngModelChange)="statusFilter.set($event)" optionLabel="label" optionValue="value" placeholder="Status"></p-select>
      <p-button label="Refresh" icon="pi pi-refresh" [outlined]="true" (click)="loadJobs()" [loading]="loading()"></p-button>
    </div>
  </div>

  <div class="stats-bar">
    <div class="stat-item">
      <span class="stat-value">{{ runningCount() }}</span>
      <span class="stat-label">Running</span>
    </div>
    <div class="stat-item">
      <span class="stat-value">{{ completedToday() }}</span>
      <span class="stat-label">Completed Today</span>
    </div>
    <div class="stat-item">
      <span class="stat-value">{{ failedToday() }}</span>
      <span class="stat-label">Failed Today</span>
    </div>
    <div class="stat-item">
      <span class="stat-value">{{ avgDuration() }}</span>
      <span class="stat-label">Avg Duration</span>
    </div>
  </div>

  <p-table
    [value]="filteredJobs()"
    [loading]="loading()"
    [paginator]="true"
    [rows]="15"
    [rowsPerPageOptions]="[15, 30, 50]"
    dataKey="id"
    responsiveLayout="scroll"
    styleClass="p-datatable-sm">

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="8">
          <div class="empty-state">
            <i class="pi pi-clock"></i>
            <p>No jobs found</p>
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="header">
      <tr>
        <th style="width: 150px">Job ID</th>
        <th style="min-width: 200px">Pipeline</th>
        <th style="width: 130px">Status</th>
        <th style="width: 150px">Progress</th>
        <th style="width: 180px">Metrics</th>
        <th pSortableColumn="startedAt" style="width: 150px">Started <p-sortIcon field="startedAt"></p-sortIcon></th>
        <th style="width: 100px">Duration</th>
        <th style="width: 120px">Actions</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-job>
      <tr (click)="openJob(job)" class="cursor-pointer">
        <td><code class="job-id">{{ job.id.substring(0, 8) }}</code></td>
        <td>
          <div class="pipeline-info">
            <span class="pipeline-name">{{ job.pipelineName }}</span>
            <span class="pipeline-version">v{{ job.pipelineVersion }}</span>
          </div>
        </td>
        <td><p-tag [value]="job.status" [severity]="getStatusSeverity(job.status)" [icon]="getStatusIcon(job.status)"></p-tag></td>
        <td>
          @if (job.status === 'running') {
            <p-progressBar [value]="job.progress" [showValue]="true" [style]="{ height: '8px' }"></p-progressBar>
          } @else if (job.status === 'completed') {
            <span class="text-green-500">100%</span>
          } @else if (job.status === 'failed') {
            <span class="text-red-500">Failed</span>
          } @else {
            <span class="text-muted">-</span>
          }
        </td>
        <td>
          @if (job.metrics) {
            <div class="metrics">
              <span><i class="pi pi-database"></i> {{ formatNumber(job.metrics.rowsProcessed) }} rows</span>
              <span><i class="pi pi-share-alt"></i> {{ formatNumber(job.metrics.quadsGenerated) }} quads</span>
            </div>
          } @else {
            <span class="text-muted">-</span>
          }
        </td>
        <td>{{ formatDate(job.startedAt) }}</td>
        <td>
          @if (job.duration) {
            {{ formatDuration(job.duration) }}
          } @else if (job.status === 'running') {
            <span class="running-timer">{{ getRunningTime(job.startedAt) }}</span>
          } @else {
            <span class="text-muted">-</span>
          }
        </td>
        <td>
          <div class="row-actions">
            @if (job.status === 'running') {
              <p-button icon="pi pi-stop" severity="danger" [text]="true" [rounded]="true" (click)="cancelJob(job, $event)" pTooltip="Cancel"></p-button>
            }
            @if (job.status === 'failed') {
              <p-button icon="pi pi-refresh" severity="warn" [text]="true" [rounded]="true" (click)="retryJob(job, $event)" pTooltip="Retry"></p-button>
            }
            <p-button icon="pi pi-file" severity="secondary" [text]="true" [rounded]="true" (click)="viewLogs(job, $event)" pTooltip="Logs"></p-button>
            <p-button icon="pi pi-external-link" [text]="true" [rounded]="true" (click)="openJob(job)" pTooltip="Details"></p-button>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>
