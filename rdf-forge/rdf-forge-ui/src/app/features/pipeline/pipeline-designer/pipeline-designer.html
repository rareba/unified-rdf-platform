<div class="pipeline-designer">
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <h1>{{ isNew() ? 'New Pipeline' : 'Edit Pipeline' }}</h1>
      @if (!isNew()) {
        <span class="pipeline-id-chip">{{ pipelineId()?.substring(0, 8) + '...' }}</span>
      }
    </div>
    <div class="actions">
      @if (validationErrors().length > 0) {
        <span class="status-chip error">
          <mat-icon>error</mat-icon>
          {{ validationErrors().length }} issues
        </span>
      } @else if (nodes().length > 0) {
        <span class="status-chip success">
          <mat-icon>check_circle</mat-icon>
          Valid
        </span>
      }
      <button mat-button (click)="cancel()">Cancel</button>
      <button mat-button (click)="clearCanvas()">
        <mat-icon>delete</mat-icon>
        Clear
      </button>
      <button mat-stroked-button (click)="showJson()">
        <mat-icon>code</mat-icon>
        JSON
      </button>
      <button mat-stroked-button color="primary" (click)="validate()">
        <mat-icon>check</mat-icon>
        Validate
      </button>
      <button mat-raised-button color="primary" (click)="save()" [disabled]="saving()">
        <mat-icon>save</mat-icon>
        Save
      </button>
      @if (!isNew()) {
        <button mat-raised-button color="accent" (click)="openRunDialog()" [disabled]="!isValid()">
          <mat-icon>play_arrow</mat-icon>
          Run
        </button>
      }
    </div>
  </div>

  <!-- Pipeline Metadata -->
  <div class="metadata-row">
    <mat-form-field class="flex-1">
      <mat-label>Pipeline Name</mat-label>
      <input matInput [ngModel]="name()" (ngModelChange)="name.set($event)" placeholder="Enter pipeline name" />
    </mat-form-field>
    <mat-form-field class="flex-1">
      <mat-label>Description</mat-label>
      <input matInput [ngModel]="description()" (ngModelChange)="description.set($event)" placeholder="Optional description" />
    </mat-form-field>
  </div>

  <!-- Main Content -->
  <div class="designer-content">
    <!-- Operations Palette -->
    <div class="palette">
      <div class="palette-header">
        <mat-icon>grid_view</mat-icon>
        <span>Operations</span>
      </div>
      <div class="palette-content">
        <mat-accordion [multi]="true">
          @for (group of operationGroups(); track group.type) {
            <mat-expansion-panel [expanded]="group.type === 'SOURCE'">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <div class="operation-group-header">
                    <mat-icon>{{ group.icon }}</mat-icon>
                    <span>{{ group.label }}</span>
                    <span class="operation-count" [attr.data-type]="group.type.toLowerCase()">
                      {{ group.operations.length }}
                    </span>
                  </div>
                </mat-panel-title>
              </mat-expansion-panel-header>
              <div class="operations-list">
                @for (op of group.operations; track op.id) {
                  <div class="operation-item"
                       draggable="true"
                       (dragstart)="onDragStart($event, op)"
                       [matTooltip]="op.description"
                       matTooltipPosition="right">
                    <div class="op-icon" [style.background-color]="getNodeBorderColor(op.type)">
                      <mat-icon class="icon-white">{{ group.icon }}</mat-icon>
                    </div>
                    <div class="op-info">
                      <span class="op-name">{{ op.name }}</span>
                      <span class="op-params">{{ (op.parameters | keyvalue).length }} params</span>
                    </div>
                  </div>
                }
              </div>
            </mat-expansion-panel>
          }
        </mat-accordion>

        @if (availableOperations().length === 0) {
          <div class="loading-state">
            <mat-spinner diameter="40"></mat-spinner>
            <p>Loading operations...</p>
          </div>
        }
      </div>
    </div>

    <!-- Canvas -->
    <div class="canvas-wrapper">
      <div class="canvas-container"
           #canvas
           (dragover)="onDragOver($event)"
           (drop)="onDrop($event)">

        <!-- Edges Layer -->
        <svg class="edges-layer">
          <defs>
            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
              <polygon points="0 0, 10 3.5, 0 7" fill="#64748b" />
            </marker>
          </defs>

          @for (edge of edges(); track edge.id) {
            <path [attr.d]="getPathForEdge(edge)"
                  stroke="#64748b"
                  stroke-width="2"
                  fill="none"
                  marker-end="url(#arrowhead)"
                  class="edge-path"
                  (click)="removeEdge(edge.id, $event)">
            </path>
          }

          @if (isDrawingEdge) {
            <path [attr.d]="getDrawingPath()" stroke="#3b82f6" stroke-width="2" stroke-dasharray="5,5" fill="none"></path>
          }
        </svg>

        <!-- Nodes Layer -->
        @for (node of nodes(); track node.id) {
          <div class="pipeline-node"
               [class.selected]="selectedNode()?.id === node.id"
               [style.left.px]="node.x"
               [style.top.px]="node.y"
               [style.border-color]="getNodeBorderColor(node.operationType)"
               (mousedown)="startNodeDrag($event, node)"
               (dblclick)="configureNode(node, $event)">

            <!-- Input Port -->
            <div class="port input-port"
                 (mouseup)="finishEdgeDraw($event, node.id)">
            </div>

            <div class="node-header">
              <span class="node-type-chip" [attr.data-type]="node.operationType.toLowerCase()">
                {{ node.operationType }}
              </span>
              <div class="node-actions">
                <mat-icon class="action-icon" (click)="configureNode(node, $event)" matTooltip="Configure">settings</mat-icon>
                <mat-icon class="action-icon delete" (click)="removeNode(node.id, $event)" matTooltip="Remove">delete</mat-icon>
              </div>
            </div>

            <div class="node-title" [title]="node.operationName">{{ node.operationName }}</div>

            <div class="node-meta">
              @if (getOperationById(node.operationId); as op) {
                @for (entry of op.parameters | keyvalue; track entry.key) {
                  @if (entry.value.required && !node.params[entry.key]) {
                    <mat-icon class="param-missing" [matTooltip]="'Missing: ' + entry.key">error</mat-icon>
                  }
                }
              }
              <span class="node-id">{{ node.id.substring(0, 8) }}</span>
            </div>

            <!-- Output Port -->
            <div class="port output-port node-connector"
                 (mousedown)="startEdgeDraw($event, node.id)">
            </div>
          </div>
        }

        <!-- Empty State -->
        @if (nodes().length === 0) {
          <div class="canvas-empty">
            <mat-icon class="empty-icon">inbox</mat-icon>
            <h3>Drag operations here to build your pipeline</h3>
            <p>Start by adding a data source from the palette on the left</p>
          </div>
        }
      </div>

      <!-- Validation Errors Panel -->
      @if (validationErrors().length > 0) {
        <div class="validation-panel">
          <div class="validation-header">
            <mat-icon>warning</mat-icon>
            <span>Validation Issues ({{ validationErrors().length }})</span>
          </div>
          <ul class="validation-list">
            @for (error of validationErrors(); track error) {
              <li>{{ error }}</li>
            }
          </ul>
        </div>
      }
    </div>
  </div>

  <!-- Configuration Dialog -->
  @if (configDialogVisible()) {
    <div class="dialog-overlay" (click)="configDialogVisible.set(false)">
      <div class="dialog-container" (click)="$event.stopPropagation()">
        <div class="dialog-header">
          <h2>Configure: {{ selectedNode()?.operationName || '' }}</h2>
          <button mat-icon-button (click)="configDialogVisible.set(false)">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        @if (selectedNode(); as node) {
          @if (selectedOperation(); as op) {
            <div class="dialog-content">
              <!-- Operation Info -->
              <div class="op-description">
                <span class="node-type-chip" [attr.data-type]="op.type.toLowerCase()">{{ op.type }}</span>
                <p class="op-desc-text">{{ op.description }}</p>
              </div>

              <mat-divider></mat-divider>

              <!-- Parameters -->
              <h3>Parameters</h3>

              @if ((op.parameters | keyvalue).length === 0) {
                <p class="no-params">This operation has no configurable parameters.</p>
              } @else {
                <div class="params-form">
                  @for (entry of op.parameters | keyvalue; track entry.key) {
                    <div class="param-field">
                      @switch (getParamType(entry.value.type)) {
                        @case ('boolean') {
                          <mat-checkbox
                            [ngModel]="node.params[entry.key]"
                            (ngModelChange)="updateNodeParam(entry.key, $event)">
                            {{ entry.value.name }}
                            @if (entry.value.required) {
                              <span class="required">*</span>
                            }
                          </mat-checkbox>
                          @if (entry.value.description) {
                            <small class="param-help">{{ entry.value.description }}</small>
                          }
                        }
                        @case ('number') {
                          <mat-form-field class="full-width">
                            <mat-label>
                              {{ entry.value.name }}
                              @if (entry.value.required) {
                                <span class="required">*</span>
                              }
                            </mat-label>
                            <input matInput type="number"
                              [ngModel]="node.params[entry.key]"
                              (ngModelChange)="updateNodeParam(entry.key, $event)"
                              [placeholder]="entry.value.defaultValue !== null ? 'Default: ' + entry.value.defaultValue : ''" />
                            @if (entry.value.description) {
                              <mat-hint>{{ entry.value.description }}</mat-hint>
                            }
                          </mat-form-field>
                        }
                        @case ('char') {
                          <mat-form-field class="full-width">
                            <mat-label>
                              {{ entry.value.name }}
                              @if (entry.value.required) {
                                <span class="required">*</span>
                              }
                            </mat-label>
                            <input matInput
                              [ngModel]="node.params[entry.key]"
                              (ngModelChange)="updateNodeParam(entry.key, $event)"
                              [maxlength]="1"
                              [placeholder]="entry.value.defaultValue !== null ? 'Default: ' + entry.value.defaultValue : ''" />
                            @if (entry.value.description) {
                              <mat-hint>{{ entry.value.description }}</mat-hint>
                            }
                          </mat-form-field>
                        }
                        @case ('map') {
                          <mat-form-field class="full-width">
                            <mat-label>
                              {{ entry.value.name }}
                              @if (entry.value.required) {
                                <span class="required">*</span>
                              }
                            </mat-label>
                            <textarea matInput
                              [ngModel]="getMapValue(entry.key)"
                              (ngModelChange)="updateMapParam(entry.key, $event)"
                              [rows]="4"
                              class="json-textarea"
                              placeholder='{"key": "value"}'></textarea>
                            @if (entry.value.description) {
                              <mat-hint>{{ entry.value.description }}</mat-hint>
                            }
                          </mat-form-field>
                          <small class="param-type">Enter valid JSON object</small>
                        }
                        @default {
                          <mat-form-field class="full-width">
                            <mat-label>
                              {{ entry.value.name }}
                              @if (entry.value.required) {
                                <span class="required">*</span>
                              }
                            </mat-label>
                            <input matInput
                              [ngModel]="node.params[entry.key]"
                              (ngModelChange)="updateNodeParam(entry.key, $event)"
                              [placeholder]="entry.value.defaultValue !== null ? 'Default: ' + entry.value.defaultValue : ''" />
                            @if (entry.value.description) {
                              <mat-hint>{{ entry.value.description }}</mat-hint>
                            }
                          </mat-form-field>
                        }
                      }

                      @if (entry.value.type && getParamType(entry.value.type) !== 'map') {
                        <small class="param-type">Type: {{ entry.value.type }}</small>
                      }
                    </div>
                  }
                </div>
              }
            </div>

            <div class="dialog-actions">
              <button mat-button (click)="configDialogVisible.set(false)">Cancel</button>
              <button mat-raised-button color="primary" (click)="saveNodeConfig()">
                <mat-icon>check</mat-icon>
                Apply
              </button>
            </div>
          }
        }
      </div>
    </div>
  }

  <!-- Run Dialog -->
  @if (runDialogVisible()) {
    <div class="dialog-overlay" (click)="runDialogVisible.set(false)">
      <div class="dialog-container" (click)="$event.stopPropagation()">
        <div class="dialog-header">
          <h2>Run Pipeline</h2>
          <button mat-icon-button (click)="runDialogVisible.set(false)">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <div class="dialog-content">
          <p><strong>Pipeline:</strong> {{ name() }}</p>

          @if (validationErrors().length > 0) {
            <div class="warning-box">
              <div class="warning-header">
                <mat-icon>warning</mat-icon>
                <strong>Warning: Pipeline has validation issues</strong>
              </div>
              <ul class="warning-list">
                @for (err of validationErrors(); track err) {
                  <li>{{ err }}</li>
                }
              </ul>
            </div>
          }

          <mat-divider></mat-divider>

          <h3>Runtime Variables (optional)</h3>
          <p class="hint-text">Override pipeline variables for this run</p>

          <div class="variable-input">
            <mat-form-field class="flex-1">
              <mat-label>Variable Name</mat-label>
              <input matInput [ngModel]="newVarKey()" (ngModelChange)="newVarKey.set($event)" placeholder="e.g. INPUT_FILE" />
            </mat-form-field>
            <mat-form-field class="flex-1">
              <mat-label>Value</mat-label>
              <input matInput [ngModel]="newVarValue()" (ngModelChange)="newVarValue.set($event)" placeholder="Value" />
            </mat-form-field>
            <button mat-icon-button color="primary" (click)="addRunVariable()" [disabled]="!newVarKey() || !newVarValue()">
              <mat-icon>add</mat-icon>
            </button>
          </div>

          @if ((runVariables() | keyvalue).length > 0) {
            <div class="variables-list">
              @for (v of runVariables() | keyvalue; track v.key) {
                <div class="variable-item">
                  <span><strong>{{ v.key }}:</strong> {{ v.value }}</span>
                  <button mat-icon-button (click)="removeRunVariable(v.key)">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              }
            </div>
          }
        </div>

        <div class="dialog-actions">
          <button mat-button (click)="runDialogVisible.set(false)">Cancel</button>
          <button mat-raised-button color="accent" (click)="run()">
            <mat-icon>play_arrow</mat-icon>
            Run Pipeline
          </button>
        </div>
      </div>
    </div>
  }

  <!-- JSON Dialog -->
  @if (jsonDialogVisible()) {
    <div class="dialog-overlay" (click)="jsonDialogVisible.set(false)">
      <div class="dialog-container large" (click)="$event.stopPropagation()">
        <div class="dialog-header">
          <h2>Pipeline JSON Definition</h2>
          <button mat-icon-button (click)="jsonDialogVisible.set(false)">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <div class="dialog-content">
          <mat-tab-group>
            <mat-tab label="Export">
              <div class="tab-content">
                <p class="hint-text">Copy this JSON to save or share the pipeline definition</p>
                <mat-form-field class="full-width">
                  <mat-label>Pipeline JSON</mat-label>
                  <textarea matInput [rows]="15" class="json-textarea" [ngModel]="pipelineJson()" readonly></textarea>
                </mat-form-field>
                <div class="tab-actions">
                  <button mat-button (click)="copyPipelineJson()">
                    <mat-icon>content_copy</mat-icon>
                    Copy to Clipboard
                  </button>
                </div>
              </div>
            </mat-tab>
            <mat-tab label="Import">
              <div class="tab-content">
                <p class="hint-text">Paste a pipeline JSON definition to import</p>
                <mat-form-field class="full-width">
                  <mat-label>Pipeline JSON</mat-label>
                  <textarea matInput [rows]="15" class="json-textarea" #importJsonText placeholder='{"steps": [...]}'></textarea>
                </mat-form-field>
                <div class="tab-actions">
                  <button mat-raised-button color="primary" (click)="importPipelineJson(importJsonText.value)">
                    <mat-icon>download</mat-icon>
                    Import
                  </button>
                </div>
              </div>
            </mat-tab>
          </mat-tab-group>
        </div>
      </div>
    </div>
  }
</div>
