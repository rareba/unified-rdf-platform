<p-toast></p-toast>

<div class="shape-editor">
  <!-- Template Selector (shown for new shapes) -->
  @if (isNew() && showTemplateSelector()) {
    <div class="template-selector">
      <div class="template-header">
        <i class="pi pi-lightbulb text-4xl text-primary mb-3"></i>
        <h1>Choose a Starting Template</h1>
        <p class="text-500">Select a template to get started quickly, or start from scratch</p>
      </div>

      <div class="template-grid">
        @for (group of templatesByCategory; track group.category) {
          <div class="template-category">
            <h3 class="text-500 text-sm font-bold mb-2">{{ group.category }}</h3>
            <div class="template-cards">
              @for (template of group.templates; track template.id) {
                <div class="template-card"
                     [class.selected]="selectedTemplate()?.id === template.id"
                     (click)="selectTemplate(template)">
                  <i [class]="template.icon" class="text-2xl mb-2"></i>
                  <div class="template-name">{{ template.name }}</div>
                  <div class="template-desc text-500 text-sm">{{ template.description }}</div>
                </div>
              }
            </div>
          </div>
        }
      </div>

      <div class="template-actions mt-4">
        <p-button label="Skip, start blank" [text]="true" (onClick)="skipTemplate()"></p-button>
        <p-button label="Use This Template" icon="pi pi-check" [disabled]="!selectedTemplate()" (onClick)="applyTemplate()"></p-button>
      </div>
    </div>
  } @else {
  <!-- Main Editor -->
  <div class="header">
    <h1>{{ isNew() ? 'Create Shape' : 'Edit Shape' }}</h1>
    <div class="actions">
      <p-toggleButton
        [(ngModel)]="visualMode"
        onLabel="Visual Mode"
        offLabel="Code Mode"
        onIcon="pi pi-eye"
        offIcon="pi pi-code"
        styleClass="mr-2">
      </p-toggleButton>
      <p-button label="Cancel" [text]="true" (onClick)="cancel()"></p-button>
      <p-button label="Save" icon="pi pi-save" (onClick)="save()" [loading]="saving()"></p-button>
    </div>
  </div>

  <div class="grid mt-4">
    <!-- Metadata -->
    <div class="col-12">
      <p-card>
        <div class="formgrid grid p-fluid">
          <div class="field col-12 md:col-6">
            <label for="name" class="font-bold">Name</label>
            <input id="name" type="text" pInputText [ngModel]="name()" (ngModelChange)="name.set($event)" />
          </div>
          <div class="field col-12 md:col-6">
            <label for="targetClass" class="font-bold">Target Class</label>
            <input id="targetClass" type="text" pInputText [ngModel]="targetClass()" (ngModelChange)="targetClass.set($event)" placeholder="http://example.org/Person" />
          </div>
          <div class="field col-12">
            <label for="uri" class="font-bold">Shape URI (Optional)</label>
            <input id="uri" type="text" pInputText [ngModel]="uri()" (ngModelChange)="uri.set($event)" placeholder="http://example.org/shapes/PersonShape" />
          </div>
        </div>
      </p-card>
    </div>

    <!-- Visual Editor -->
    @if (visualMode()) {
    <div class="col-12">
      <div class="grid">
        <!-- Property List (Left) -->
        <div class="col-12 md:col-4">
          <p-panel header="Properties" styleClass="h-full">
            <div class="flex flex-column gap-2">
              <p-button label="Add Property" icon="pi pi-plus" styleClass="w-full mb-2" (onClick)="addProperty()"></p-button>
              
              <div class="property-list" style="max-height: 600px; overflow-y: auto;">
                @for (prop of properties(); track prop.id) {
                  <div class="property-item p-3 border-1 border-round mb-2 cursor-pointer hover:surface-hover transition-colors transition-duration-200"
                       [class.border-primary]="selectedProperty()?.id === prop.id"
                       [class.surface-card]="selectedProperty()?.id !== prop.id"
                       [class.surface-50]="selectedProperty()?.id === prop.id"
                       (click)="selectProperty(prop)">
                    <div class="flex align-items-center justify-content-between">
                      <div class="flex align-items-center gap-2">
                        <i class="pi" [ngClass]="getIconForKind(prop.kind)"></i>
                        <div>
                          <div class="font-bold text-900">{{ prop.name || 'Unnamed Property' }}</div>
                          <div class="text-sm text-500">{{ prop.path || 'No path' }}</div>
                        </div>
                      </div>
                      <div class="flex gap-1">
                        @if (prop.minCount && prop.minCount > 0) {
                          <p-tag value="Req" severity="danger" styleClass="text-xs"></p-tag>
                        }
                        <i class="pi pi-trash text-500 hover:text-red-500 cursor-pointer p-2" (click)="removeProperty(prop); $event.stopPropagation()"></i>
                      </div>
                    </div>
                  </div>
                }
                @if (properties().length === 0) {
                  <div class="text-center text-500 py-4">No properties defined. Click 'Add Property' to start.</div>
                }
              </div>
            </div>
          </p-panel>
        </div>

        <!-- Property Details (Right) -->
        <div class="col-12 md:col-8">
          @if (selectedProperty(); as prop) {
            <p-panel [header]="prop.name || 'Property Details'" styleClass="h-full">
              <p-tabs value="general">
                <p-tablist>
                  <p-tab value="general">General</p-tab>
                  <p-tab value="constraints">Constraints</p-tab>
                  <p-tab value="advanced">Advanced</p-tab>
                </p-tablist>
                <p-tabpanels>
                  
                  <!-- General Tab -->
                  <p-tabpanel value="general">
                    <div class="formgrid grid p-fluid">
                      <div class="field col-12">
                        <label class="font-bold">Property Name (Label)</label>
                        <input pInputText type="text" [(ngModel)]="prop.name" placeholder="e.g., Email Address" />
                      </div>
                      <div class="field col-12">
                        <label class="font-bold">Path (URI)</label>
                        <input pInputText type="text" [(ngModel)]="prop.path" placeholder="e.g., schema:email" />
                        <small class="text-500">The RDF predicate this property constrains.</small>
                      </div>
                      <div class="field col-12 md:col-6">
                        <label class="font-bold">Kind</label>
                        <p-select [options]="kindOptions" [(ngModel)]="prop.kind" optionLabel="label" optionValue="value"></p-select>
                      </div>
                      <div class="field col-12 md:col-6">
                        <label class="font-bold">{{ prop.kind === 'LITERAL' ? 'Datatype' : 'Target Class' }}</label>
                        @if (prop.kind === 'LITERAL') {
                          <p-select [options]="datatypeOptions" [(ngModel)]="prop.datatype" optionLabel="label" optionValue="value" [editable]="true"></p-select>
                        } @else {
                          <input pInputText type="text" [(ngModel)]="prop.datatype" placeholder="e.g., schema:Person" />
                        }
                      </div>
                      <div class="field col-12">
                        <label class="font-bold">Description</label>
                        <textarea pInputTextarea [(ngModel)]="prop.description" rows="3"></textarea>
                      </div>
                    </div>
                  </p-tabpanel>

                  <!-- Constraints Tab -->
                  <p-tabpanel value="constraints">
                    <!-- Quick Presets for Non-Experts -->
                    <div class="constraint-presets mb-4">
                      <label class="font-bold block mb-2">Quick Presets</label>
                      <div class="flex flex-wrap gap-2">
                        @for (preset of constraintPresets; track preset.id) {
                          <p-button
                            [label]="preset.label"
                            [icon]="preset.icon"
                            [outlined]="true"
                            size="small"
                            [pTooltip]="preset.description"
                            (onClick)="applyConstraintPreset(preset)">
                          </p-button>
                        }
                      </div>
                    </div>

                    <p-divider></p-divider>

                    <div class="formgrid grid p-fluid">
                      <div class="field col-12 md:col-6">
                        <label class="font-bold">Is this field required?</label>
                        <div class="flex align-items-center gap-3 mt-2">
                          <p-checkbox [binary]="true" label="Required (must have a value)" [ngModel]="prop.minCount !== null && prop.minCount > 0" (ngModelChange)="$event ? prop.minCount = 1 : prop.minCount = 0"></p-checkbox>
                        </div>
                        <small class="text-500 mt-1 block">Minimum occurrences: {{ prop.minCount ?? 0 }}</small>
                      </div>
                      <div class="field col-12 md:col-6">
                        <label class="font-bold">How many values allowed?</label>
                        <div class="flex align-items-center gap-3 mt-2">
                          <p-checkbox [binary]="true" label="Single value only" [ngModel]="prop.maxCount === 1" (ngModelChange)="prop.maxCount = $event ? 1 : null"></p-checkbox>
                        </div>
                        <small class="text-500 mt-1 block">Maximum: {{ prop.maxCount ?? 'Unlimited' }}</small>
                      </div>

                      @if (prop.kind === 'LITERAL') {
                        <div class="field col-12">
                          <label class="font-bold">Must match a pattern?</label>
                          <input pInputText type="text" [(ngModel)]="prop.pattern" placeholder="e.g., ^[A-Z][0-9]+$ for codes like A123" />
                          <small class="text-500">Regular expression pattern the value must match</small>
                        </div>
                        <div class="field col-12 md:col-6">
                          <label class="font-bold">Minimum text length</label>
                          <input pInputText type="number" [(ngModel)]="prop.minLength" min="0" placeholder="No minimum" />
                        </div>
                        <div class="field col-12 md:col-6">
                          <label class="font-bold">Maximum text length</label>
                          <input pInputText type="number" [(ngModel)]="prop.maxLength" min="0" placeholder="No maximum" />
                        </div>
                      }
                    </div>
                  </p-tabpanel>

                  <!-- Advanced Tab -->
                  <p-tabpanel value="advanced">
                    <div class="formgrid grid p-fluid">
                      <div class="field col-12">
                        <label class="font-bold">Custom Validation Message</label>
                        <input pInputText type="text" [(ngModel)]="prop.message" placeholder="e.g., Value must be a valid email" />
                      </div>
                      <div class="field col-12">
                        <label class="font-bold">Node Kind</label>
                        <p-select [options]="nodeKindOptions" [(ngModel)]="prop.nodeKind" optionLabel="label" optionValue="value" [showClear]="true" placeholder="Default"></p-select>
                      </div>
                    </div>
                  </p-tabpanel>

                </p-tabpanels>
              </p-tabs>
            </p-panel>
          } @else {
            <div class="h-full flex flex-column align-items-center justify-content-center surface-ground border-round p-6 text-center text-500">
              <i class="pi pi-arrow-left text-4xl mb-3"></i>
              <div class="text-xl font-bold">Select a property</div>
              <div>Select a property from the list or create a new one to edit its details.</div>
            </div>
          }
        </div>
      </div>
    </div>
    }

    <!-- Code Editor -->
    @if (!visualMode()) {
    <div class="col-12">
      <p-card>
        <div class="flex justify-content-between align-items-center mb-3">
          <div class="font-bold text-xl">Shape Definition</div>
          <div class="flex gap-2">
            <p-select [options]="formatOptions" [ngModel]="contentFormat()" (ngModelChange)="contentFormat.set($event)" optionLabel="label" optionValue="value"></p-select>
            <p-button label="Validate Syntax" icon="pi pi-check-circle" [outlined]="true" (onClick)="validateSyntax()"></p-button>
          </div>
        </div>
        <textarea pInputTextarea [ngModel]="content()" (ngModelChange)="content.set($event)" class="w-full font-mono" rows="20"></textarea>
      </p-card>
    </div>
    }

    <!-- Test Lab -->
    <div class="col-12">
      <p-panel header="Test Lab" [toggleable]="true" [collapsed]="true">
        <div class="grid">
          <div class="col-12 md:col-6">
            <div class="flex justify-content-between align-items-center mb-2">
              <label class="font-bold">Test Data</label>
              <p-select [options]="testFormatOptions" [ngModel]="testDataFormat()" (ngModelChange)="testDataFormat.set($event)" optionLabel="label" optionValue="value"></p-select>
            </div>
            <textarea pInputTextarea [ngModel]="testData()" (ngModelChange)="testData.set($event)" class="w-full font-mono" rows="10" placeholder="Enter RDF data to validate against this shape..."></textarea>
            <div class="mt-2 text-right">
              <p-button label="Run Validation" icon="pi pi-play" (onClick)="runValidation()" [loading]="validating()"></p-button>
            </div>
          </div>
          <div class="col-12 md:col-6">
            <label class="font-bold block mb-2">Results</label>
            @if (validationResult(); as result) {
              <div class="p-3 border-round" [ngClass]="result.conforms ? 'bg-green-50 text-green-700 border-green-200' : 'bg-red-50 text-red-700 border-red-200'">
                <div class="flex align-items-center gap-2 mb-3">
                  <i class="pi" [ngClass]="result.conforms ? 'pi-check-circle' : 'pi-times-circle'" style="font-size: 1.5rem"></i>
                  <span class="font-bold text-xl">{{ result.conforms ? 'Conforms' : 'Violation' }}</span>
                </div>
                @if (!result.conforms) {
                  <div class="flex flex-column gap-2">
                    @for (violation of result.violations; track violation) {
                      <div class="surface-card p-2 border-round text-700 border-1 border-300 text-sm">
                        <div class="font-bold">{{ violation.message }}</div>
                        <div class="text-xs text-500 mt-1">
                          Focus: {{ violation.focusNode }} 
                          @if (violation.path) { | Path: {{ violation.path }} }
                        </div>
                      </div>
                    }
                  </div>
                }
              </div>
            } @else {
              <div class="h-full flex align-items-center justify-content-center text-500 border-1 border-dashed border-300 border-round" style="min-height: 200px">
                Run validation to see results
              </div>
            }
          </div>
        </div>
      </p-panel>
    </div>
  </div>
  } <!-- end of else block for template selector -->
</div>
