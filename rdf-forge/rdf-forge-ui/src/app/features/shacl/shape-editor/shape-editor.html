<div class="shape-editor">
  <!-- Template Selector (shown for new shapes) -->
  @if (isNew() && showTemplateSelector()) {
    <div class="template-selector">
      <div class="template-header">
        <mat-icon class="lightbulb-icon">lightbulb</mat-icon>
        <h1>Choose a Starting Template</h1>
        <p class="subtitle">Select a template to get started quickly, or start from scratch</p>
      </div>

      <div class="template-grid">
        @for (group of templatesByCategory; track group.category) {
          <div class="template-category">
            <h3 class="category-title">{{ group.category }}</h3>
            <div class="template-cards">
              @for (template of group.templates; track template.id) {
                <mat-card class="template-card"
                     [class.selected]="selectedTemplate()?.id === template.id"
                     (click)="selectTemplate(template)">
                  <mat-card-content>
                    <mat-icon class="template-icon">{{ template.icon }}</mat-icon>
                    <div class="template-name">{{ template.name }}</div>
                    <div class="template-desc">{{ template.description }}</div>
                  </mat-card-content>
                </mat-card>
              }
            </div>
          </div>
        }
      </div>

      <div class="template-actions">
        <button mat-button (click)="skipTemplate()">Skip, start blank</button>
        <button mat-raised-button color="primary" [disabled]="!selectedTemplate()" (click)="applyTemplate()">
          <mat-icon>check</mat-icon>
          Use This Template
        </button>
      </div>
    </div>
  } @else {
  <!-- Main Editor -->
  <div class="header">
    <h1>{{ isNew() ? 'Create Shape' : 'Edit Shape' }}</h1>
    <div class="actions">
      <mat-button-toggle-group [(ngModel)]="visualMode" class="mode-toggle">
        <mat-button-toggle [value]="true">
          <mat-icon>visibility</mat-icon>
          Visual Mode
        </mat-button-toggle>
        <mat-button-toggle [value]="false">
          <mat-icon>code</mat-icon>
          Code Mode
        </mat-button-toggle>
      </mat-button-toggle-group>
      <button mat-button (click)="cancel()">Cancel</button>
      <button mat-raised-button color="primary" (click)="save()" [disabled]="saving()">
        <mat-icon>save</mat-icon>
        Save
      </button>
    </div>
  </div>

  <div class="grid-container">
    <!-- Metadata -->
    <div class="metadata-section">
      <mat-card>
        <mat-card-content>
          <div class="form-grid">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Name</mat-label>
              <input matInput [ngModel]="name()" (ngModelChange)="name.set($event)" />
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Target Class</mat-label>
              <input matInput [ngModel]="targetClass()" (ngModelChange)="targetClass.set($event)" placeholder="http://example.org/Person" />
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Shape URI (Optional)</mat-label>
              <input matInput [ngModel]="uri()" (ngModelChange)="uri.set($event)" placeholder="http://example.org/shapes/PersonShape" />
            </mat-form-field>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Visual Editor -->
    @if (visualMode()) {
    <div class="visual-editor-section">
      <div class="editor-layout">
        <!-- Property List (Left) -->
        <div class="property-list-panel">
          <mat-card>
            <mat-card-header>
              <mat-card-title>Properties</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <button mat-raised-button color="primary" class="add-property-btn" (click)="addProperty()">
                <mat-icon>add</mat-icon>
                Add Property
              </button>

              <div class="property-list">
                @for (prop of properties(); track prop.id) {
                  <div class="property-item"
                       [class.selected]="selectedProperty()?.id === prop.id"
                       (click)="selectProperty(prop)">
                    <div class="property-header">
                      <div class="property-info">
                        <mat-icon class="property-icon">{{ getIconForKind(prop.kind) }}</mat-icon>
                        <div>
                          <div class="property-name">{{ prop.name || 'Unnamed Property' }}</div>
                          <div class="property-path">{{ prop.path || 'No path' }}</div>
                        </div>
                      </div>
                      <div class="property-actions">
                        @if (prop.minCount && prop.minCount > 0) {
                          <mat-chip class="required-chip">Req</mat-chip>
                        }
                        <button mat-icon-button (click)="removeProperty(prop); $event.stopPropagation()">
                          <mat-icon color="warn">delete</mat-icon>
                        </button>
                      </div>
                    </div>
                  </div>
                }
                @if (properties().length === 0) {
                  <div class="empty-state">No properties defined. Click 'Add Property' to start.</div>
                }
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Property Details (Right) -->
        <div class="property-details-panel">
          @if (selectedProperty(); as prop) {
            <mat-card>
              <mat-card-header>
                <mat-card-title>{{ prop.name || 'Property Details' }}</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <mat-tab-group>
                  <!-- General Tab -->
                  <mat-tab label="General">
                    <div class="tab-content">
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Property Name (Label)</mat-label>
                        <input matInput [(ngModel)]="prop.name" placeholder="e.g., Email Address" />
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Path (URI)</mat-label>
                        <input matInput [(ngModel)]="prop.path" placeholder="e.g., schema:email" />
                        <mat-hint>The RDF predicate this property constrains.</mat-hint>
                      </mat-form-field>

                      <div class="two-column">
                        <mat-form-field appearance="outline">
                          <mat-label>Kind</mat-label>
                          <mat-select [(ngModel)]="prop.kind">
                            @for (option of kindOptions; track option.value) {
                              <mat-option [value]="option.value">{{ option.label }}</mat-option>
                            }
                          </mat-select>
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                          <mat-label>{{ prop.kind === 'LITERAL' ? 'Datatype' : 'Target Class' }}</mat-label>
                          @if (prop.kind === 'LITERAL') {
                            <mat-select [(ngModel)]="prop.datatype">
                              @for (option of datatypeOptions; track option.value) {
                                <mat-option [value]="option.value">{{ option.label }}</mat-option>
                              }
                            </mat-select>
                          } @else {
                            <input matInput [(ngModel)]="prop.datatype" placeholder="e.g., schema:Person" />
                          }
                        </mat-form-field>
                      </div>

                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Description</mat-label>
                        <textarea matInput [(ngModel)]="prop.description" rows="3"></textarea>
                      </mat-form-field>
                    </div>
                  </mat-tab>

                  <!-- Constraints Tab -->
                  <mat-tab label="Constraints">
                    <div class="tab-content">
                      <!-- Quick Presets for Non-Experts -->
                      <div class="constraint-presets">
                        <label class="preset-label">Quick Presets</label>
                        <div class="preset-buttons">
                          @for (preset of constraintPresets; track preset.id) {
                            <button
                              mat-stroked-button
                              [matTooltip]="preset.description"
                              (click)="applyConstraintPreset(preset)">
                              <mat-icon>{{ preset.icon }}</mat-icon>
                              {{ preset.label }}
                            </button>
                          }
                        </div>
                      </div>

                      <mat-divider></mat-divider>

                      <div class="constraint-fields">
                        <div class="constraint-section">
                          <label class="section-label">Is this field required?</label>
                          <mat-checkbox
                            [checked]="prop.minCount !== null && prop.minCount > 0"
                            (change)="$event.checked ? prop.minCount = 1 : prop.minCount = 0">
                            Required (must have a value)
                          </mat-checkbox>
                          <div class="hint">Minimum occurrences: {{ prop.minCount ?? 0 }}</div>
                        </div>

                        <div class="constraint-section">
                          <label class="section-label">How many values allowed?</label>
                          <mat-checkbox
                            [checked]="prop.maxCount === 1"
                            (change)="prop.maxCount = $event.checked ? 1 : null">
                            Single value only
                          </mat-checkbox>
                          <div class="hint">Maximum: {{ prop.maxCount ?? 'Unlimited' }}</div>
                        </div>

                        @if (prop.kind === 'LITERAL') {
                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>Must match a pattern?</mat-label>
                            <input matInput [(ngModel)]="prop.pattern" placeholder="e.g., ^[A-Z][0-9]+$ for codes like A123" />
                            <mat-hint>Regular expression pattern the value must match</mat-hint>
                          </mat-form-field>

                          <div class="two-column">
                            <mat-form-field appearance="outline">
                              <mat-label>Minimum text length</mat-label>
                              <input matInput type="number" [(ngModel)]="prop.minLength" min="0" placeholder="No minimum" />
                            </mat-form-field>

                            <mat-form-field appearance="outline">
                              <mat-label>Maximum text length</mat-label>
                              <input matInput type="number" [(ngModel)]="prop.maxLength" min="0" placeholder="No maximum" />
                            </mat-form-field>
                          </div>
                        }
                      </div>
                    </div>
                  </mat-tab>

                  <!-- Advanced Tab -->
                  <mat-tab label="Advanced">
                    <div class="tab-content">
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Custom Validation Message</mat-label>
                        <input matInput [(ngModel)]="prop.message" placeholder="e.g., Value must be a valid email" />
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Node Kind</mat-label>
                        <mat-select [(ngModel)]="prop.nodeKind" placeholder="Default">
                          @for (option of nodeKindOptions; track option.value) {
                            <mat-option [value]="option.value">{{ option.label }}</mat-option>
                          }
                        </mat-select>
                      </mat-form-field>
                    </div>
                  </mat-tab>
                </mat-tab-group>
              </mat-card-content>
            </mat-card>
          } @else {
            <div class="empty-property-state">
              <mat-icon class="empty-icon">arrow_back</mat-icon>
              <div class="empty-title">Select a property</div>
              <div class="empty-message">Select a property from the list or create a new one to edit its details.</div>
            </div>
          }
        </div>
      </div>
    </div>
    }

    <!-- Code Editor -->
    @if (!visualMode()) {
    <div class="code-editor-section">
      <mat-card>
        <mat-card-header>
          <mat-card-title>Shape Definition</mat-card-title>
          <div class="header-actions">
            <mat-form-field appearance="outline" class="format-select">
              <mat-select [ngModel]="contentFormat()" (ngModelChange)="contentFormat.set($event)">
                @for (option of formatOptions; track option.value) {
                  <mat-option [value]="option.value">{{ option.label }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
            <button mat-stroked-button (click)="validateSyntax()">
              <mat-icon>check_circle</mat-icon>
              Validate Syntax
            </button>
          </div>
        </mat-card-header>
        <mat-card-content>
          <mat-form-field appearance="outline" class="full-width code-editor">
            <textarea matInput [ngModel]="content()" (ngModelChange)="content.set($event)" rows="20"></textarea>
          </mat-form-field>
        </mat-card-content>
      </mat-card>
    </div>
    }

    <!-- Test Lab -->
    <div class="test-lab-section">
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>Test Lab</mat-panel-title>
        </mat-expansion-panel-header>
        <div class="test-lab-content">
          <div class="test-data-panel">
            <div class="panel-header">
              <label class="panel-label">Test Data</label>
              <mat-form-field appearance="outline" class="format-select">
                <mat-select [ngModel]="testDataFormat()" (ngModelChange)="testDataFormat.set($event)">
                  @for (option of testFormatOptions; track option.value) {
                    <mat-option [value]="option.value">{{ option.label }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>
            <mat-form-field appearance="outline" class="full-width">
              <textarea matInput [ngModel]="testData()" (ngModelChange)="testData.set($event)" rows="10" placeholder="Enter RDF data to validate against this shape..."></textarea>
            </mat-form-field>
            <div class="test-actions">
              <button mat-raised-button color="primary" (click)="runValidation()" [disabled]="validating()">
                <mat-icon>play_arrow</mat-icon>
                Run Validation
              </button>
            </div>
          </div>

          <div class="test-results-panel">
            <label class="panel-label">Results</label>
            @if (validationResult(); as result) {
              <div class="result-container" [class.success]="result.conforms" [class.error]="!result.conforms">
                <div class="result-header">
                  <mat-icon class="result-icon">{{ result.conforms ? 'check_circle' : 'cancel' }}</mat-icon>
                  <span class="result-status">{{ result.conforms ? 'Conforms' : 'Violation' }}</span>
                </div>
                @if (!result.conforms) {
                  <div class="violations-list">
                    @for (violation of result.violations; track violation) {
                      <mat-card class="violation-card">
                        <mat-card-content>
                          <div class="violation-message">{{ violation.message }}</div>
                          <div class="violation-details">
                            Focus: {{ violation.focusNode }}
                            @if (violation.path) { | Path: {{ violation.path }} }
                          </div>
                        </mat-card-content>
                      </mat-card>
                    }
                  </div>
                }
              </div>
            } @else {
              <div class="empty-results">
                Run validation to see results
              </div>
            }
          </div>
        </div>
      </mat-expansion-panel>
    </div>
  </div>
  }
</div>
